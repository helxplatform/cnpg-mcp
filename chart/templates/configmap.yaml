apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "cnpg-mcp.fullname" . }}-oidc-config
  labels:
    {{- include "cnpg-mcp.labels" . | nindent 4 }}
data:
  oidc.yaml: |
    # OIDC/OAuth2 Authentication Configuration
    # Auto-generated from Helm values

    # REQUIRED: OIDC Issuer URL
    issuer: {{ .Values.oidc.issuer | quote }}

    # REQUIRED: Expected audience claim in JWT tokens
    audience: {{ .Values.oidc.audience | quote }}

    {{- if .Values.oidc.jwksUri }}
    # OPTIONAL: Override JWKS URI (auto-discovered from issuer by default)
    jwks_uri: {{ .Values.oidc.jwksUri | quote }}
    {{- end }}

    {{- if .Values.oidc.dcrProxyUrl }}
    # OPTIONAL: DCR (Dynamic Client Registration) proxy URL
    dcr_proxy_url: {{ .Values.oidc.dcrProxyUrl | quote }}
    {{- end }}

    {{- if .Values.oidc.scope }}
    # OPTIONAL: Required OAuth2 scope
    scope: {{ .Values.oidc.scope | quote }}
    {{- end }}

    {{- if and .Values.ingress.enabled .Values.ingress.host }}
    # Public URL of this MCP server (derived from ingress configuration)
    # Used for OAuth metadata registration_endpoint
    public_url: {{ if .Values.ingress.tls.enabled }}"https://{{ .Values.ingress.host }}"{{ else }}"http://{{ .Values.ingress.host }}"{{ end }}
    {{- end }}

    {{- if .Values.oidc.mgmt_client_id }}
    # Management API client ID for updating DCR-created clients
    # Converts confidential clients to public clients to prevent token encryption
    mgmt_client_id: {{ .Values.oidc.mgmt_client_id | quote }}
    {{- end }}

    {{- if .Values.oidc.clientSecretsSecret }}
    # Path to management API client secret file (mounted from Kubernetes Secret)
    mgmt_client_secret_file: "/etc/mcp/secrets/client-secret"
    {{- end }}

    {{- if .Values.oidc.clientSecretsSecret }}
    # Path to client secrets file (mounted from Kubernetes Secret)
    # Required for Auth0 and other IdPs that encrypt ID tokens (JWE)
    client_secrets_file: "/etc/mcp/secrets/client-secrets.yaml"
    {{- end }}
