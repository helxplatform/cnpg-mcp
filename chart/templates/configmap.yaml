apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "cnpg-mcp.fullname" . }}-oidc-config
  labels:
    {{- include "cnpg-mcp.labels" . | nindent 4 }}
data:
  oidc.yaml: |
    # FastMCP OAuth Proxy Configuration for Auth0
    # Auto-generated from Helm values
    #
    # The MCP server uses FastMCP's built-in OAuth Proxy to handle token issuance:
    # - Receives Auth0 tokens internally (may be JWE encrypted)
    # - Issues MCP-signed JWT tokens to clients (NOT Auth0 tokens)
    # - Manages session binding between Auth0 and MCP tokens

    # ========================================================================
    # REQUIRED: Auth0 Configuration
    # ========================================================================

    # Auth0 domain (OIDC issuer URL)
    issuer: {{ .Values.oidc.issuer | quote }}

    # API identifier (expected audience claim in tokens)
    audience: {{ .Values.oidc.audience | quote }}

    # Auth0 application client ID (pre-registered application)
    client_id: {{ .Values.oidc.clientId | quote }}

    {{- if .Values.oidc.clientSecretsSecret }}
    # Path to Auth0 client secret file (mounted from Kubernetes Secret)
    # This is the secret for the pre-registered Auth0 application
    # FastMCP OAuth Proxy uses this to exchange authorization codes for tokens
    # The secret should be mounted at this path by the deployment
    client_secret_file: "/etc/mcp/secrets/client-secret"
    {{- end }}

    # ========================================================================
    # REQUIRED: Server Configuration
    # ========================================================================

    {{- if and .Values.ingress.enabled .Values.ingress.host }}
    # Public URL of this MCP server (derived from ingress configuration)
    # Used for OAuth callbacks and metadata endpoints
    public_url: {{ if .Values.ingress.tls.enabled }}"https://{{ .Values.ingress.host }}"{{ else }}"http://{{ .Values.ingress.host }}"{{ end }}
    {{- end }}

    # ========================================================================
    # OPTIONAL: Advanced Configuration
    # ========================================================================

    {{- if .Values.oidc.jwksUri }}
    # Override JWKS URI (auto-discovered from issuer by default)
    jwks_uri: {{ .Values.oidc.jwksUri | quote }}
    {{- end }}

    {{- if .Values.oidc.scope }}
    # Required OAuth2 scope (default: openid)
    scope: {{ .Values.oidc.scope | quote }}
    {{- end }}
